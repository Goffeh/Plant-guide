<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1b5e20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Plant Guide">
  <link rel="manifest" href="manifest.json">
  <title>Plant Families of the world ID app also offline</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-gradient-start: #e8f5e9;
      --bg-gradient-end: #c8e6c9;
      --text-primary: #1b5e20;
      --text-secondary: #2e7d32;
      --card-bg: white;
      --input-bg: white;
      --input-border: #ddd;
      --shadow: rgba(0,0,0,0.1);
    }
    
    body.dark-mode {
      --bg-gradient-start: #1a1a1a;
      --bg-gradient-end: #0d3d0d;
      --text-primary: #a5d6a7;
      --text-secondary: #81c784;
      --card-bg: #2a2a2a;
      --input-bg: #1a1a1a;
      --input-border: #4a4a4a;
      --shadow: rgba(0,0,0,0.3);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      padding: 10px;
      min-height: 100vh;
      color: var(--text-primary);
      transition: background 0.3s, color 0.3s;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    .theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--card-bg);
      border: 2px solid var(--text-secondary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px var(--shadow);
      z-index: 1000;
    }
    
    .upload-screen {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-top: 60px;
      box-shadow: 0 2px 8px var(--shadow);
      text-align: center;
    }
    .upload-icon { font-size: 48px; margin-bottom: 15px; }
    .upload-title {
      font-size: 24px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    .upload-subtitle {
      color: var(--text-secondary);
      margin-bottom: 20px;
      font-size: 14px;
    }
    .csv-textarea {
      width: 100%;
      min-height: 200px;
      padding: 10px;
      border: 2px solid var(--text-secondary);
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      margin-bottom: 15px;
      background: var(--input-bg);
      color: var(--text-primary);
    }
    .load-btn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
    }
    .save-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }
    .tip-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 10px;
      line-height: 1.4;
    }
    
    h1 {
      color: var(--text-primary);
      font-size: 24px;
      margin-bottom: 5px;
      margin-top: 50px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 15px;
    }
    .reload-btn {
      background: #ff9800;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    .search-panel {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .search-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .clear-btn {
      background: #ffebee;
      color: #c62828;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .search-grid {
      display: grid;
      gap: 12px;
    }
    .search-box {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .search-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .add-search-btn {
      background: #4caf50;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .search-input-wrapper {
      position: relative;
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }
    .search-input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
    }
    .search-input:focus {
      outline: none;
      border-color: #4caf50;
    }
    .remove-search-btn {
      background: #f44336;
      color: white;
      border: none;
      width: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .tip {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 10px;
      line-height: 1.4;
    }
    .results-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
    }
    .active-filters {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .cards-grid {
      display: grid;
      gap: 12px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px var(--shadow);
      border-left: 4px solid #4caf50;
      cursor: pointer;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .card-title { flex: 1; }
    .family-name {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .order-name {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .card-badges {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .badge-group {
      background: #c8e6c9;
      color: #1b5e20;
    }
    .badge-species {
      background: #bbdefb;
      color: #0d47a1;
    }
    body.dark-mode .badge-group {
      background: #2e7d32;
      color: #a5d6a7;
    }
    body.dark-mode .badge-species {
      background: #1565c0;
      color: #90caf9;
    }
    .card-content { font-size: 13px; }
    .detail-row { margin-bottom: 8px; }
    .detail-label {
      font-weight: 600;
      color: var(--text-primary);
    }
    .detail-value {
      color: var(--text-secondary);
      margin-left: 4px;
    }
    .expand-hint {
      text-align: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--input-border);
      font-size: 11px;
      color: #4caf50;
    }
    .no-results {
      text-align: center;
      padding: 40px 20px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 6px var(--shadow);
    }
    .no-results-title {
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .no-results-text {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .hidden { display: none; }
    @media (min-width: 768px) {
      .search-grid { grid-template-columns: repeat(2, 1fr); }
      .cards-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 1024px) {
      .search-grid { grid-template-columns: repeat(3, 1fr); }
      .cards-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô</button>

  <div class="container">
    <div id="uploadScreen" class="upload-screen">
      <div class="upload-icon">üåø</div>
      <div class="upload-title">Plant Family Database</div>
      <div class="upload-subtitle">Load your CSV data</div>
      
      <input type="file" id="fileInput" accept=".csv" style="display:none;" onchange="handleFileUpload(event)">
      <button class="load-btn" onclick="document.getElementById('fileInput').click()">üìÅ Choose CSV File</button>
      
      <div style="text-align: center; margin: 15px 0; color: var(--text-secondary); font-size: 14px;">OR</div>
      
      <textarea id="csvInput" class="csv-textarea" placeholder="Paste your entire CSV here (including header row)..."></textarea>
      
      <button class="load-btn" onclick="loadCSV()">üìä Load Data</button>
      <button class="save-btn" onclick="saveCSV()">üíæ Save for Next Time</button>
      
      <div class="tip-text">üí° Works on iPhone & Android ‚Ä¢ Add to home screen for app-like experience</div>
    </div>
    
    <div id="appScreen" class="hidden">
      <h1>üåø Plant Family Guide</h1>
      <div class="subtitle">Up to 5 searches per field ‚Ä¢ <span id="familyCount">0</span> families ‚Ä¢ Works offline</div>
      
      <button class="reload-btn" onclick="showUpload()">üìÅ Load Different CSV</button>
      
      <div class="search-panel">
        <div class="search-header">
          <div class="search-title">üîç Search</div>
          <button class="clear-btn" onclick="clearAll()" id="clearBtn" style="display:none;">Clear (<span id="activeCount">0</span>)</button>
        </div>
        
        <div class="search-grid">
          <div class="search-box">
            <label class="search-label">Family</label>
            <div class="search-input-wrapper">
              <input type="text" class="search-input" placeholder="Rosaceae" oninput="filterFamilies()" id="family">
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">Genera</label>
            <div class="search-input-wrapper">
              <input type="text" class="search-input" placeholder="Rosa, Acacia" oninput="filterFamilies()" id="genera">
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Growth Form</span>
              <button class="add-search-btn" onclick="addSearchInput('growth')">+</button>
            </label>
            <div id="growthInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="trees, shrubs..." oninput="filterFamilies()" data-field="growth">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Leaf Characteristics</span>
              <button class="add-search-btn" onclick="addSearchInput('leaf')">+</button>
            </label>
            <div id="leafInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="opposite, compound..." oninput="filterFamilies()" data-field="leaf">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Flower Characteristics</span>
              <button class="add-search-btn" onclick="addSearchInput('flower')">+</button>
            </label>
            <div id="flowerInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="tubular, bisexual..." oninput="filterFamilies()" data-field="flower">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Fruit Characteristics</span>
              <button class="add-search-btn" onclick="addSearchInput('fruit')">+</button>
            </label>
            <div id="fruitInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="drupes, fleshy..." oninput="filterFamilies()" data-field="fruit">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Distribution</span>
              <button class="add-search-btn" onclick="addSearchInput('distribution')">+</button>
            </label>
            <div id="distributionInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Cosmopolitan..." oninput="filterFamilies()" data-field="distribution">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Reproductive Strategy</span>
              <button class="add-search-btn" onclick="addSearchInput('reproductive')">+</button>
            </label>
            <div id="reproductiveInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Hermaphroditic..." oninput="filterFamilies()" data-field="reproductive">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Dispersal Type</span>
              <button class="add-search-btn" onclick="addSearchInput('dispersal')">+</button>
            </label>
            <div id="dispersalInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Wind, Animals..." oninput="filterFamilies()" data-field="dispersal">
              </div>
            </div>
          </div>
          
          <div class="search-box">
            <label class="search-label">
              <span>Uses/Info</span>
              <button class="add-search-btn" onclick="addSearchInput('uses')">+</button>
            </label>
            <div id="usesInputs">
              <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Ornamental, Food..." oninput="filterFamilies()" data-field="uses">
              </div>
            </div>
          </div>
        </div>
        
        <div class="tip">üí° Click + to add up to 5 search boxes per field</div>
      </div>
      
      <div class="results-bar">
        <span>üìä <span id="filteredCount">0</span> of <span id="totalCount">0</span></span>
        <span class="active-filters" id="activeFilters" style="display:none;">
          üîΩ <span id="activeFiltersCount">0</span> active
        </span>
      </div>
      
      <div class="cards-grid" id="cardsContainer"></div>
      
      <div class="no-results" id="noResults" style="display:none;">
        <div class="no-results-title">No matches</div>
        <div class="no-results-text">Try different keywords</div>
      </div>
    </div>
  </div>

  <script>
    let families = [];
    let expandedCard = null;
    const searchCounts = {
      growth: 1, leaf: 1, flower: 1, fruit: 1,
      distribution: 1, reproductive: 1, dispersal: 1, uses: 1
    };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(() => {});
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', isDark);
    }

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
    }

    function addSearchInput(field) {
      if (searchCounts[field] >= 5) {
        alert('Maximum 5 search boxes per field');
        return;
      }
      
      const container = document.getElementById(field + 'Inputs');
      const index = searchCounts[field];
      
      const wrapper = document.createElement('div');
      wrapper.className = 'search-input-wrapper';
      wrapper.innerHTML = `
        <input type="text" class="search-input" placeholder="Keyword ${index + 1}" oninput="filterFamilies()" data-field="${field}">
        <button class="remove-search-btn" onclick="removeSearchInput(this, '${field}')">√ó</button>
      `;
      
      container.appendChild(wrapper);
      searchCounts[field]++;
    }

    function removeSearchInput(btn, field) {
      if (searchCounts[field] <= 1) return;
      btn.parentElement.remove();
      searchCounts[field]--;
      filterFamilies();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvText = e.target.result;
        document.getElementById('csvInput').value = csvText;
        
        families = parseCSV(csvText);
        
        if (families.length === 0) {
          alert('No families found. Check CSV format.');
          return;
        }
        
        document.getElementById('uploadScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');
        
        document.getElementById('familyCount').textContent = families.length;
        document.getElementById('totalCount').textContent = families.length;
        filterFamilies();
        
        setTimeout(() => {
          if (confirm('Data loaded! Save for next time?')) {
            try {
              localStorage.setItem('plantCSV', csvText);
              alert('‚úÖ Saved!');
            } catch (e) {}
          }
        }, 500);
      };
      reader.readAsText(file);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    function parseCSV(csv) {
      try {
        csv = csv.replace(/^\uFEFF/, '').trim();
        const lines = csv.split(/\r?\n/).filter(line => line.trim());
        
        if (lines.length < 2) return [];
        
        const headers = parseCSVLine(lines[0]);
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
          try {
            const values = parseCSVLine(lines[i]);
            const obj = {};
            
            headers.forEach((header, idx) => {
              const cleanHeader = header.replace(/^["']|["']$/g, '').trim();
              obj[cleanHeader] = values[idx] ? values[idx].replace(/^["']|["']$/g, '').trim() : '';
            });
            
            if (obj.Family && obj.Family.trim()) {
              data.push(obj);
            }
          } catch (e) {}
        }
        
        return data;
      } catch (error) {
        return [];
      }
    }

    function loadCSV() {
      const csvText = document.getElementById('csvInput').value.trim();
      
      if (!csvText) {
        alert('Please paste CSV data first!');
        return;
      }
      
      families = parseCSV(csvText);
      
      if (families.length === 0) {
        alert('No families found.');
        return;
      }
      
      document.getElementById('uploadScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');
      
      document.getElementById('familyCount').textContent = families.length;
      document.getElementById('totalCount').textContent = families.length;
      filterFamilies();
    }

    function saveCSV() {
      const csvText = document.getElementById('csvInput').value.trim();
      
      if (!csvText) {
        alert('Please paste CSV data first!');
        return;
      }
      
      try {
        localStorage.setItem('plantCSV', csvText);
        alert('‚úÖ Saved! Auto-loads next time.');
      } catch (e) {
        alert('Could not save.');
      }
    }

    function showUpload() {
      document.getElementById('appScreen').classList.add('hidden');
      document.getElementById('uploadScreen').classList.remove('hidden');
    }

    function getFieldValues(field) {
      const inputs = document.querySelectorAll(`input[data-field="${field}"]`);
      return Array.from(inputs).map(input => input.value.trim().toLowerCase()).filter(v => v);
    }

    function filterFamilies() {
      const familyVal = document.getElementById('family').value.trim().toLowerCase();
      const generaVal = document.getElementById('genera').value.trim().toLowerCase();
      
      const growthVals = getFieldValues('growth');
      const leafVals = getFieldValues('leaf');
      const flowerVals = getFieldValues('flower');
      const fruitVals = getFieldValues('fruit');
      const distVals = getFieldValues('distribution');
      const reproVals = getFieldValues('reproductive');
      const dispersalVals = getFieldValues('dispersal');
      const usesVals = getFieldValues('uses');
      
      const filtered = families.filter(family => {
        const matchFamily = !familyVal || (family.Family || '').toLowerCase().includes(familyVal);
        const matchGenera = !generaVal || (family['Common genera'] || '').toLowerCase().includes(generaVal);
        
        const growthText = (family['Growth Form'] || '').toLowerCase();
        const matchGrowth = growthVals.length === 0 || growthVals.every(v => growthText.includes(v));
        
        const leafText = (family['Leaf Characteristics'] || '').toLowerCase();
        const matchLeaf = leafVals.length === 0 || leafVals.every(v => leafText.includes(v));
        
        const flowerText = (family['Flower Characteristics'] || '').toLowerCase();
        const matchFlower = flowerVals.length === 0 || flowerVals.every(v => flowerText.includes(v));
        
        const fruitText = (family['Fruit Characteristics'] || '').toLowerCase();
        const matchFruit = fruitVals.length === 0 || fruitVals.every(v => fruitText.includes(v));
        
        const distText = (family.Distribution || '').toLowerCase();
        const matchDist = distVals.length === 0 || distVals.every(v => distText.includes(v));
        
        const reproText = (family['Reproductive Strategy'] || '').toLowerCase();
        const matchRepro = reproVals.length === 0 || reproVals.every(v => reproText.includes(v));
        
        const dispersalText = (family['Common Dispersal Type'] || '').toLowerCase();
        const matchDispersal = dispersalVals.length === 0 || dispersalVals.every(v => dispersalText.includes(v));
        
        const usesText = (family['Uses/other info'] || '').toLowerCase();
        const matchUses = usesVals.length === 0 || usesVals.every(v => usesText.includes(v));
        
        return matchFamily && matchGenera && matchGrowth && matchLeaf && 
               matchFlower && matchFruit && matchDist && matchRepro && 
               matchDispersal && matchUses;
      });
      
      const allInputs = document.querySelectorAll('.search-input');
      const activeCount = Array.from(allInputs).filter(input => input.value.trim()).length;
      
      document.getElementById('activeCount').textContent = activeCount;
      document.getElementById('activeFiltersCount').textContent = activeCount;
      document.getElementById('clearBtn').style.display = activeCount > 0 ? 'block' : 'none';
      document.getElementById('activeFilters').style.display = activeCount > 0 ? 'block' : 'none';
      
      renderCards(filtered);
    }

    function renderCards(filtered) {
      const container = document.getElementById('cardsContainer');
      const noResults = document.getElementById('noResults');
      
      document.getElementById('filteredCount').textContent = filtered.length;
      
      if (filtered.length === 0) {
        container.style.display = 'none';
        noResults.style.display = 'block';
        return;
      }
      
      container.style.display = 'grid';
      noResults.style.display = 'none';
      
      container.innerHTML = filtered.map((family, idx) => {
        const isExpanded = expandedCard === idx;
        
        return `
          <div class="card" onclick="toggleCard(${idx})">
            <div class="card-header">
              <div class="card-title">
                <div class="family-name">${family.Family}</div>
                <div class="order-name">${family.Order}</div>
              </div>
              <div class="card-badges">
                ${family.Group ? `<span class="badge badge-group">${family.Group}</span>` : ''}
                ${family['Sp. estimate'] ? `<span class="badge badge-species">~${family['Sp. estimate']} spp.</span>` : ''}
              </div>
            </div>
            <div class="card-content">
              ${family['Common genera'] ? `<div class="detail-row"><span class="detail-label">Genera:</span><span
